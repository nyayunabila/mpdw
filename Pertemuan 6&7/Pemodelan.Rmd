---
title: "Pertemuan 6&7 - Pemodelan Data"
author: Nyayu Azzahra Nabila
date: "2025-10-02"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
    theme: united
  pdf_document:
    toc: true
    toc_depth: '3'
editor_options:
  markdown:
    wrap: 72
  wrap: 72
---

## Packages

```{r}
library(ggplot2)
library(tsibble)
library(tseries)
library(MASS)
library(forecast)
library(TSA)
library(TTR)
library(aTSA)
library(graphics)
```

## Input Data

Import data kelompok dari github

```{r}
library (rio)
all <- import("https://raw.githubusercontent.com/nyayunabila/mpdw/refs/heads/main/data%20kelompok%209%20-%20Sheet1.csv")
all
```

Setelah itu ambil data sesuai dengan pembagian kelompok

```{r}
#ambil baris 101-200
subset_data <- all[101:200, 2]

subset_data <- gsub(",", ".", subset_data)

subset_data <- as.numeric(subset_data)

#gabungkan data.frame dengan subset_data
fmcg <- data.frame(
  periode = 1:100,
  daily_revenue = subset_data
)
```

Mengubah data agar terbaca sebagai data deret waktu dengan fungsi `ts()`
.

```{r}
fmcg.ts <- ts(fmcg$daily_revenue)
```

Menampilkan ringkasan data

```{r}
summary(fmcg.ts)
```

## Eksplorasi Data

### Plot Data Penuh

```{r}
plot.ts(fmcg.ts, lty=1, xlab="waktu", ylab="Daily_Revenue", main="Plot Data Daily Revenue")
```

Dari plot terlihat bahwa data tidak memiliki plot musiman yang jelas.
Data tampak berfluktuasi di sekitar nilai tengah yang konstan (tidak ada
tren naik atau pun turun). Lebar pita juga tampak relatif seragam
meskipun ada beberapa lonjakan ekstrim.

Sehingga kita akan membagi data dengan:

-   Training data: 80% (periode 1-80)

-   Testing data: 20% (periode 81-100)

### Plot Data Training

```{r}
train_data <- fmcg.ts[1:80]
plot.ts(train_data, lty=1, xlab="waktu", ylab="Daily_Revenue", main="Plot Data Training Daily Revenue")
```

Dari plot terlihat bahwa data tidak memiliki plot musiman yang jelas.
Data tampak berfluktuasi di sekitar nilai tengah yang konstan (tidak ada
tren naik atau pun turun). Lebar pita juga tampak relatif seragam
meskipun ada beberapa lonjakan ekstrim.

### Plot Data Testing

```{r}
test_data <- fmcg.ts[81:100]
plot.ts(test_data, lty=1, xlab="waktu", ylab="Daily_Revenue", main="Plot Data Testing Daily Revenue")
```

## Uji Stationeritas Data

### Plot ACF

```{r}
acf(train_data, main="ACF Data Training Daily Revenue")
```

Plot ACF menunjukkan korelasi antara suatu nilai deret waktu dengan
nilai-nilai masa lalunya (lag). Garis putus-putus biru menunjukkan batas
signifikansi.

Nah, indikasi yang terlihat pada plot ACF adalah menunjukkan korelasi
yang turun dengan cepat bukan turun secara perlahan/tails off. Artinya
data ini stationer dalam rataan (d=0). Akan dibuktikan dengan uji
statistik.

### Uji ADF

```{r}
tseries::adf.test(train_data)
```

Hipotesis:

$H_0$: Data tidak stasioner dalam rataan (memiliki unit root)

$H_1$: Data stasione dalam rataan

Karena p-value (0.01) lebih kecil dari α (0.05), maka Tolak H0, dapat
disimpulkan bahwa **data training stationer dalam rataan** pada taraf
nyata 5%.

### Plot Box-Cox

```{r}
index <- seq (1:80)
bc = MASS :: boxcox(train_data~index,lambda = seq(-2,2, by=0.01))

lambda=bc$x[which.max(bc$y)]
lambda

bc$x[bc$y > max(bc$y) - 1/2 * qchisq(.95,1)]
```

Plot Boxcox menunjukkan nilai *rounded value* ($\lambda$) optimum
sebesar **0.34** dan pada selang kepercayaan 95% nilai memiliki batas
bawah **0.04** dan batas atas **0.67**. Selang tersebut tidak memuat
nilai satu sehingga dapat dikatakan bahwa data bangkitan **tidak
stasioner dalam ragam.**

### Penanganan Ketidakstationeran Data

Karena data tidak stationer dalam ragam makan dilakukan transformasi
Box-Cox dengan nilai $\lambda$ = 0.34

akan digunakan rumus boxcox standar yaitu

$$y_t^{(\lambda)} = \begin{cases} \frac{y_t^\lambda - 1}{\lambda} & \text{untuk } \lambda \neq 0 \\ \ln(y_t) & \text{untuk } \lambda = 0 \end{cases}$$

```{r}
lambda_optimum <- 0.34

train_data_bc <- (train_data^lambda_optimum - 1) / lambda_optimum
```

### Plot Data Training Setelah Transformasi Box-Cox

#### Plot ACF

```{r}
acf(train_data_bc, main="ACF Data Training Daily Revenue Setelah Transformasi Box-Cox")
```

Plot ACF menunjukkan korelasi yang turun dengan cepat bukan turun secara
perlahan/tails off. Artinya data ini **stationer dalam rataan** (d=0).
Akan dibuktikan dengan uji statistik.

#### Uji ADF

```{r}
tseries::adf.test(train_data_bc)
```

Karena p-value (0.01) lebih kecil dari α (0.05), maka Tolak $H_0$, dapat
disimpulkan bahwa data training **stationer dalam rataan** pada taraf
nyata 5%.

#### Plot Box-cox

```{r}
index <- seq (1:80)
bc = MASS :: boxcox(train_data_bc~index,lambda = seq(-2,2, by=0.01))

lambda=bc$x[which.max(bc$y)]
lambda

bc$x[bc$y > max(bc$y) - 1/2 * qchisq(.95,1)]
```

lambda optimum sebesar **1.01** dan pada selang kepercayaan 95% nilai
memiliki batas bawah **0.30** dan batas atas **1.78**. Selang tersebut
memuat nilai satu sehingga dapat dikatakan bahwa data bangkitan **sudah
stasioner dalam ragam.**

#### Kesimpulan data setelah transformasi box-cox

Setelah dilakukan transformasi **data sudah stationer baik stationer
dalam rataan maupun ragam,** sehingga tidak perlu dilakukan differencing
(d=0). Selanjutnya akan dilakukan pemodelan.

## Identifikasi Model

Setelah dilakukan penanganan transformasi box-cox ketidakstationeran
data, maka akan dilakukan identifikasi model dengan plot ACF dan PACF.

### Plot ACF

```{r}
acf(train_data_bc, main="ACF Data Training Daily Revenue Setelah Transformasi Box-Cox")
```

Semua lag berada di dalam batas signifikansi.

### Plot PACF

```{r}
pacf(train_data_bc, main="PACF Data Training Daily Revenue Setelah Transformasi Box-Cox")
```

Semua lag berada di dalam batas signifikansi.

**Dari plot ACF dan PACF tidak ada lag yang signifikan, sehingga model
yang dapat digunakan adalah model ARIMA(0,0,0).**

### Plot EACF

```{r}
eacf(train_data_bc)
```

Identifikasi model menggunakan plot EACF dilakukan dengan melihat ujung
segitiga pada pola segitiga nol. **Dalam hal ini model tentatif yang
terbentuk adalah ARIMA(0,0,0), ARIMA(1,0,1), ARIMA(2,0,0), ARIMA
(3,0,1)**

## Pendugaan Parameter Model Tentatif

### ARIMA (0,0,0)

```{r}
model1.da=Arima(train_data_bc, order=c(0,0,0),method="ML")
summary(model1.da) #AIC=410.69
lmtest::coeftest(model1.da) #seluruh parameter signifikan
```

### ARIMA (1,0,1)

```{r}
model2.da=Arima(train_data_bc, order=c(1,0,1),method="ML")
summary(model2.da) #AIC=409.89
lmtest::coeftest(model2.da) #seluruh parameter signifikan
```

### ARIMA (2,0,0)

```{r}
model3.da=Arima(train_data_bc, order=c(2,0,0),method="ML")
summary(model3.da) #AIC=413.2
lmtest::coeftest(model3.da) #tidak ada parameter signifikan
```

### ARIMA (3,0,1)

```{r}
model4.da=Arima(train_data_bc, order=c(3,0,1),method="ML")
summary(model4.da) #AIC=413.69
lmtest::coeftest(model4.da) #2 parameter signifikan
```

Berdasarkan pendugaan parameter di atas, nilai **AIC terkecil** dimiliki
oleh model ARIMA(1,0,1) dan parameter model ARIMA(1,0,1) juga
**seluruhnya signifikan** sehingga model yang dipilih adalah model
**ARIMA(1,0,1).**

## Analisis Sisaan

Model terbaik hasil identifikasi kemudian dicek asumsi sisaannya. Sisaan
model ARIMA harus memenuhi asumsi normalitas, kebebasan sisaan, dan
kehomogenan ragam. Diagnostik model dilakukan secara eksplorasi dan uji
formal.

### Eksplorasi Sisaan

```{r}
sisaan.da <- model2.da$residuals 
par(mfrow=c(2,2)) 
qqnorm(sisaan.da) 
qqline(sisaan.da, col = "blue", lwd = 2) 
plot(c(1:length(sisaan.da)),sisaan.da) 
acf(sisaan.da) 
pacf(sisaan.da) 
par(mfrow = c(1,1))
```

1.  Normal Q-Q Plot Secara visual, sisaan menunjukkan **distribusi tak
    normal**, ada sedikit penyimpangan di bagian ekor.

2.  Plot sisaan vs waktu, rata-rata siaan tampaknya **bergerak di
    sekitar nol**, lebar pita penyebaran juga tampak seragam.

3.  Plot ACF Semua batang autokorelasi (dari Lag 1 hingga Lag 20) berada
    di dalam batas signifikansi, ini menunjukkan bahwa **sisaan saling
    bebas.**

4.  Plot PACF Semua batang korelasi parsial (dari Lag 1 hingga Lag 20)
    berada di dalam batas signifikansi (garis putus-putus biru),
    mengkonfirmasi bahwa sisaan adalah **White Noise.**

Akan dibuktikan dengan uji lanjut

### Uji Formal

#### Normalitas

```{r}
ks.test(sisaan.da,"pnorm")  #tak tolak H0 > sisaan menyebar normal
```

Pada tahapan ini uji formal yang digunakan untuk normalitas adalah uji
Kolmogorov-Smirnov (KS). Hipotesis pada uji KS adalah sebagai berikut.

$H_0$ : Sisaan menyebar normal

$H_1$ : Sisaan tidak menyebar normal

Berdasarkan uji KS tersebut, didapat *p-value* sebesar 0.00003 yang
kurang dari taraf nyata 5% sehingga tolak $H_0$ dan menandakan bahwa
sisaan **tidak menyebar normal**. Hal ini sesuai dengan hasil eksplorasi
menggunakan plot kuantil-kuantil normal.

#### Sisaan saling bebas

```{r}
Box.test(sisaan.da, type = "Ljung")  #tak tolak H0 > sisaan saling bebas
```

Selanjutnya akan dilakukan uji formal untuk kebebasan sisaan menggunakan
uji Ljung-Box. Hipotesis yang digunakan adalah sebagai berikut.

$H_0$ : Sisaan saling bebas

$H_1$ : Sisaan tidak tidak saling bebas

Berdasarkan uji Ljung-Box tersebut, didapat *p-value* sebesar 0.8073
yang lebih besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan
menandakan bahwa **sisaan saling bebas**.

#### Kehomogenan ragam

```{r}
Box.test((sisaan.da)^2, type = "Ljung")  #tak tolak H0 > sisaan homogen
```

Hipotesis yang digunakan untuk uji kehomogenan ragam adalah sebagai
berikut.

$H_0$ : Ragam sisaan homogen

$H_1$ : Ragam sisaan tidak homogen

Berdasarkan uji Ljung-Box terhadap sisaan kuadrat tersebut, didapat
*p-value* sebesar 0.4447 yang lebih dari taraf nyata 5% sehingga tak
tolak $H_0$ dan menandakan bahwa **ragam sisaan homogen.**

#### Nilai tengah sama dengan 0

```{r}
t.test(sisaan.da, mu = 0, conf.level = 0.95)  #tak tolak h0 > nilai tengah sisaan sama dengan 0
```

$H_0$ : nilai tengah sisaan sama dengan 0

$H_1$ : nilai tengah sisaan tidak sama dengan 0

Berdasarkan uji-ttersebut, didapat *p-value* sebesar 0.2991 yang lebih
besar dari taraf nyata 5% sehingga tak tolak $H_0$ dan menandakan bahwa
**nilai tengah sisaan sama dengan nol.**

#### Kesimpulan Uji Sisaan dengan uji formal

1.  Sisaan tidak menyebar normal
2.  Sisaan saling bebas
3.  Ragam sisaan homogen
4.  Nilai tengah sisaan sama dengan nol

## Overfitting

Tahapan selanjutnya adalah *overfitting* dilakukan dengan menaikkan orde
AR(p) dan MA(q) dari model ARIMA(1,0,1) untuk melihat apakah terdapat
model lain yang lebih baik dari model saat ini. Kandidat model
*overfitting* adalah ARIMA(2,0,1) dan ARIMA(1,0,2).

```{r}
model2a.da=Arima(train_data_bc, order=c(2,0,1),method="ML")
summary(model2a.da) #411.72
lmtest::coeftest(model2a.da) #ar2 tidak signifikan

model2b.da=Arima(train_data_bc, order=c(1,0,2),method="ML")
summary(model2b.da) #411.71   
lmtest::coeftest(model2b.da) #ma2 tidak signifikan

#model yang dipilih adalah model awal, yaitu ARIMA(1,0,1)
```

Berdasarkan kedua model hasil *overfitting* di atas, model ARIMA(2,0,1)
dan ARIMA(1,0,2) memiliki **AIC yang lebih besar** dibandingkan dengan
model ARIMA(1,0,1) dan parameter kedua model ARIMA(2,0,1) dan
ARIMA(1,0,2) **tidak seluruhnya signifikan.** Oleh karena itu, model
**ARIMA(1,0,1)** akan **tetap digunakan untuk melakukan peramalan.**

## Peramalan

Peramalan dilakukan menggunakan fungsi `forecast()` . Contoh peramalan
berikut ini dilakukan untuk 20 hari ke depan **(h=20 agar sesuai dengan
panjang data uji)**

```{r}
ramalan <- forecast::forecast(model2.da, h = 20) 
ramalan
data.ramalan <- ramalan$mean
plot(ramalan)
```

Berdasarkan hasil plot ramalan di atas, dapat dilihat bahwa ramalan
ARIMA (1,0,1) cenderung stabil hingga akhir periode. Selanjutnya, dapat
dicari nilai akurasi antara hasil ramalan dengan data uji sebagai
berikut.

```{r}
# Transformasi balik (Inverse Box-Cox)

# Pastikan lambda bukan nol, jika lambda sangat dekat dengan nol, gunakan exp()
if (lambda_optimum != 0) {
  
  # Rumus untuk lambda TIDAK SAMA DENGAN nol
  hasil.ramalan.asli <- (data.ramalan* lambda_optimum + 1)^(1/lambda_optimum)

} else {
  
  # Jika lambda = 0, transformasi balik adalah eksponensial (exp)
  hasil.ramalan.asli <- exp(data.ramalan)

}

# Konversi hasil ramalan asli menjadi objek deret waktu (ts)
hasil.ramalan.asli.ts <- ts(hasil.ramalan.asli)
hasil.ramalan.asli.ts
```

```{r}
perbandingan.fmcg <- matrix(data = c(head(test_data, n = 20), head(hasil.ramalan.asli, n = 20)), 
                            nrow = 20, 
                            ncol = 2)

colnames(perbandingan.fmcg) <- c("Aktual (test_data)", "Hasil Forecast (Skala Asli)")

perbandingan.fmcg

accuracy(ts(head(hasil.ramalan.asli, n =20)), 
         head(test_data, n = 20))
```

Kesimpulan:

1.  Model ARIMA(1,0,1) terpilih sebagai model terbaik berdasarkan nilai
    AIC terkecil dan seluruh parameter signifikan pada data yang di
    transformasi Box-Cox.

2.  Hasil uji sisaan menunjukkan bahwa sisaan saling bebas, ragam sisaan
    homogen, dan nilai tengah sisaan sama dengan nol tetapi sisaan tidak
    menyebar normal.

3.  Hasil peramalan dengan model ARIMA(1,0,1):

    3.1 **RMSE** = 71.61892, kesalahan ramalan (dalam skala asli) sangat
    besar.

    3.2 **MAPE** = 29.16029%, kesalahan persentase ramalan rata-rata
    hampir 30%, yang dianggap tidak akurat untuk peramalan bisnis.

    3.3 **Rentang aktual** = 71.17 hingga 321.10, data uji berfluktuasi
    liar

    3.4 **Rentang ramalan** = 153.47 hingga 153.69, Ramalan datar dan
    mendekati nilai 153.

## Insight

Model ARMA(1,1) secara teknis adalah **model** **terbaik untuk
menghilangkan autokorelasi** (berdasarkan diagnostik), tetapi **tidak
memiliki kekuatan prediktif yang memadai**. Hasil peramalan menunjukkan
bahwa data Daily Revenue terlalu volatil dan strukturnya terlalu
lemah/acak untuk diprediksi secara akurat oleh model ARIMA sederhana.
Dalam kasus ini, model ARIMA yang 'terbaik' secara statistik masih
menghasilkan ramalan yang tidak berguna secara praktis (ramalan datar)
karena data aktual berperilaku sangat acak. Sehingga, **Model
ARIMA(1,0,1) kurang cocok** untuk meramalkan data Daily Revenue yang
**memiliki fluktuasi tinggi.**
